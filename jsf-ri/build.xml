<?xml version='1.0' encoding='UTF-8'?>

<!--
 Copyright 2003 Sun Microsystems, Inc. All rights reserved.
 SUN PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
-->


<!-- ************ JSF build file ************************************** -->

<project name="JSF-RI" default="main" basedir=".">

  <property name="Name" value="JavaServer Faces RI"/>
  <property name="name" value="jsf-impl"/>
  <property name="version" value="20040120"/>

<!-- ************ Per user local properties ******************************* -->

  <property file="build.properties"/>                <!-- Component local   -->
  <property file="../build.properties"/>             <!-- Commons local     -->
  <property file="${user.home}/build.properties"/>   <!-- User local        -->
  <property environment="myenv" />


<!-- ************ Where are we building into? ***************************** -->

  <!-- the root of our tomcat -->

  <!-- The base directory for compilation targets -->
  <property name="build.home" value="${basedir}/build"/>

  <property name="build.generate"   value="${build.home}/generate"/>
  <property name="build.generate.tld"   value="${build.generate}/conf/share"/>

  <!-- The base directory for the JSF APIs -->
  <property name="jsf-api.home" value ="../jsf-api"/>

  <property name="jsf-tools.dir"    value="${basedir}/../jsf-tools"/>

  <!-- The base directory for distribution targets -->
  <property name="dist.home" value="${basedir}/dist"/>

  <!-- The base directory for component sources -->
  <property name="source.home" value="${basedir}/src"/>

  <!-- The base directory for component tests -->
  <property name="test.home" value="${basedir}/test"/>

  <!-- The base directory for dependent jars -->
  <property name="lib.home" value="${basedir}/lib"/>

  <!-- The base directory for executable scripts -->
  <property name="bin.home" value="${basedir}/etc/bin"/>

  <!-- The home directory for Ant -->
  <property name="ant.home" value="${basedir}/lib"/>

  <!-- The base directory of the JSF TCK -->
  <property name="jsf-tck.home" value="../jsf-tck"/>


  <!-- ************ Dependencies **** *************************************** -->

  <!-- The locations of necessary jar files -->
  <property name="servlet.jar" value="${tomcat.home}/common/lib/servlet-api.jar"/>
  <property name="jsp.jar" value="${tomcat.home}/common/lib/jsp-api.jar"/>
  <property name="catalina-ant.jar" value="${tomcat.home}/server/lib/catalina-ant.jar"/>
  <property name="commons-logging.jar" 
            value="${tomcat.home}/jwsdp-shared/lib/commons-logging.jar"/>
  <property name="commons-digester.jar" 
            value="${tomcat.home}/jwsdp-shared/lib/commons-digester.jar"/>
  <property name="commons-beanutils.jar" 
            value="${tomcat.home}/jwsdp-shared/lib/commons-beanutils.jar"/>
  <property name="commons-collections.jar" 
            value="${tomcat.home}/jwsdp-shared/lib/commons-collections.jar"/>
  <property name="jstl.jar" 
            value="${tomcat.home}/jstl/lib/jstl.jar"/>
  <property name="standard.jar" 
            value="${tomcat.home}/jstl/lib/standard.jar"/>
  <property name="jsf-api.jar" value="${jsf-api.home}/build/lib/jsf-api.jar"/>
  <property name="jsf-api.dtd" value="${jsf-api.home}/build/lib/web-facesconfig_1_0.dtd"/>
  <property name="tlddoc.jar" value="${tomcat.home}/../tlddoc-1_0/tlddoc.jar"/>

<!-- ************ Compiler Defaults *************************************** -->

  <!-- Should Java compilations set the 'debug' compiler option? -->
  <property name="compile.debug" value="true"/>

  <!-- Should Java compilations set the 'deprecation' compiler option? -->
  <property name="compile.deprecation" value="false"/>

  <!-- Should Java compilations set the 'optimize' compiler option? -->
  <property name="compile.optimize" value="false"/>

  <!-- Construct compile classpath -->
  <path id="compile.classpath">
    <pathelement location="${build.home}/classes"/>
    <pathelement location="${commons-beanutils.jar}"/>
    <pathelement location="${commons-collections.jar}"/>
    <pathelement location="${commons-digester.jar}"/>
    <pathelement location="${commons-logging.jar}"/>
    <pathelement location="${jsf-api.jar}"/>
    <pathelement location="${servlet.jar}"/>
    <pathelement location="${jsp.jar}"/> 
    <pathelement location="${jstl.jar}"/>
  </path>

  <path id="catalina-ant.classpath">
    <pathelement location="${catalina-ant.jar}"/>
  </path>

  <!-- Custom Tomcat Integration -->
  <taskdef  name="list"     classname="org.apache.catalina.ant.ListTask">
        <classpath>
          <pathelement location="${catalina-ant.jar}" />
        </classpath>
  </taskdef>    
  <property name="url"      value="http://localhost:8080/manager"/>


    <!-- Directory where tlds are stored -->
    <property name="conf.share.dir" value="conf/share"/>


<!-- ************ Executable Targets ************************************** -->

  <!-- 
       ===================================================================
         Convenience target: cvs update              
       =================================================================== 
  -->
  <target name="cvsupdate">
    <cvs command="update -d -P"/>
  </target>

  <!-- 
       ===================================================================
         Convenience target: pull.clean.build
       =================================================================== 
  -->
  <target name="pull.clean.build" depends="cvsupdate,clean,main">
  </target>


  <target name="init"
   description="Initialize and evaluate conditionals">
    <echo message="-------- ${Name} ${version} --------"/>
  </target>

  <target name="prepare" 
          depends="init,detect.tck,set.tools.property,verify.tools.property"
   description="Prepare build directory">
    <mkdir dir="${build.home}"/>
    <mkdir dir="${build.home}/generate"/>
    <mkdir dir="${build.home}/bin"/>
    <mkdir dir="${build.home}/classes"/>
    <mkdir dir="${build.home}/classes/META-INF"/>
    <mkdir dir="${build.home}/javadocs"/>
    <mkdir dir="${build.home}/tlddocs"/>
    <mkdir dir="${build.home}/lib"/>
  </target>

  <target name="prepare.generate"
          depends="prepare,set.tools.property,verify.tools.property">
    <mkdir dir="${build.generate.tld}"/>
  </target>

  <target name="set.tools.property" unless="jsf-tools">
    <available property="jsf-tools" value="${jsf-tools.dir}"
               file="${jsf-tools.dir}/build.xml"/>
  </target>

  <target name="verify.tools.property" unless="jsf-tools">

<fail>
You must have the property jsf-tools defined, or the path ../jsf-tools
must exist.  This is necessary for the MessageFactory class.
</fail>
  </target>

  <target name="copy.template.sources" depends="prepare"
     description="Copy template sources from ${jsf-tools.dir}/template-source">

    <mkdir dir="${build.generate}/com/sun/faces/util"/>
    <filter token="protection" value="public"/>

    <filter token="package" value="com.sun.faces.util"/>
    <copy file="${jsf-tools.dir}/template-src/MessageFactory.java" 
          todir="${build.generate}/com/sun/faces/util"
          filtering="true"/>

  </target>

  <target name="check.taglib.generation.necessity" if="jsf-tools">
    <uptodate property="skip.taglib.generation"
              targetfile="${build.generate}/last-taglib-generation">
       <srcfiles dir="${jsf-api.home}/doc">
         <include name="*.xml"/>
       </srcfiles>
    </uptodate>
  </target>

  <target name="generate" depends="prepare.generate,check.taglib.generation.necessity"
          if="jsf-tools" unless="skip.taglib.generation">
    <echo>
      jsf-tools is ${jsf-tools.dir}
    </echo>

    <ant dir="${jsf-tools.dir}" inheritall="false" target="clean.generated.taglib"/>

    <ant dir="${jsf-tools.dir}" inheritall="false" target="generate.taglib"/>

    <copy todir="${build.generate}">

      <fileset dir="${jsf-tools.dir}/build/generate">
        <include name="conf/**/*.*"/>
        <include name="com/**/*.*"/>
        <exclude name="com/sun/faces/taglib/html_basic/*_LinkTag.java"/>
      </fileset>
    </copy>

    <touch file="${build.generate}/last-taglib-generation"/>

  </target>

  <target name="compile" depends="prepare,generate,copy.template.sources"
   description="Just compile the classes">
    <!-- Run javac through everything -->
    <javac srcdir="${source.home}:${build.generate}"
           destdir="${build.home}/classes"
             debug="${compile.debug}"
       deprecation="${compile.deprecation}"
          optimize="${compile.optimize}">
      <classpath refid="compile.classpath"/>
    </javac>

    <copy todir="${build.home}/classes">
        <fileset dir="${source.home}" includes="**/*.properties"/>
    </copy>
    <copy todir="${build.home}/classes">
        <fileset dir="${source.home}" includes="**/*.xml"/>
    </copy>
    <copy  file="${jsf-api.dtd}"
          todir="${build.home}/classes/com/sun/faces/config"/>

    <copy file="${build.generate.tld}/html_basic.tld"
         toDir="${build.home}/classes/META-INF"/>
    <copy file="${conf.share.dir}/jsf_core.tld"
         toDir="${build.home}/classes/META-INF"/>

    </target>

  <target name="clean" 
   description="Clean build and distribution directories">
    <ant antfile="build-tests.xml" target="safe.remove"/>
    <ant antfile="build-tests.xml" target="remove.tstamp"/>
    <delete    dir="${build.home}"/>
    <delete    dir="${dist.home}"/>
    <delete> 
      <fileset dir="." includes="**/*~" defaultexcludes="no"/>
      <fileset dir="." includes="**/.nbattrs" defaultexcludes="no"/>
    </delete>
    <delete file="jsf-${version}.zip"/>
    <delete file="jsf-${version}_src.zip"/>
    <delete  dir="${tomcat.home}/jsf-${version}/lib" />
    <ant dir="${basedir}/systest" inheritall="false" target="safe.remove"/>  
    <ant dir="${basedir}/systest" inheritall="false" target="clean"/>  
    <ant antfile="build-tests.xml" target="remove.jsp.incompat.workaround"/>
  </target>

  <target name="all" depends="clean,prepare,compile"
   description="Clean and compile all components"/>

  <!-- Create the source distribution -->
  <target name="ri.source">
    <zip     destfile="${dist.home}/jsf-ri-src-${version}.zip">
      <zipfileset dir="${basedir}"
             includes="build.xml build-tests.xml README COPYRIGHT LICENSE*.*"
               prefix="jsf-ri-src-${version}"/>
      <zipfileset dir="${source.home}"
             excludes="**/CVS/**"
               prefix="jsf-ri-src-${version}/src"/>
      <zipfileset dir="${test.home}"
             excludes="**/CVS/**"
               prefix="jsf-ri-src-${version}/test"/>
      <zipfileset dir="${basedir}"
             includes="conf/** web/**"
               prefix="jsf-ri-src-${version}"/>
    </zip>
  </target>


  <target name="dist" depends="jars" description="Build distribution files">
    <mkdir dir="${dist.home}"/>

    <antcall target="tlddocs"/>

    <!-- Create the binary distribution -->
    <zip     destfile="${dist.home}/jsf-ri-${version}.zip">
      <zipfileset dir="${build.home}"
             includes="lib/**,tlddocs/**"
               prefix="jsf-ri-${version}"/>
    </zip>

    <!-- Create a buildable source distribution -->
    <zip     destfile="${dist.home}/jsf-ri-src-${version}.zip">
      <zipfileset dir="${basedir}"
             includes="build.xml build-tests.xml README COPYRIGHT LICENSE*.*"
               prefix="jsf-ri-src-${version}"/>
      <zipfileset dir="${source.home}"
             excludes="**/CVS/**"
               prefix="jsf-ri-src-${version}/src"/>
      <zipfileset dir="${test.home}"
             excludes="**/CVS/**"
               prefix="jsf-ri-src-${version}/test"/>
      <zipfileset dir="${basedir}/systest"
             excludes="**/CVS/**"
               prefix="jsf-ri-src-${version}/systest"/>
      <zipfileset dir="${basedir}"
             includes="conf/** web/**"
	     excludes="**/fruitstand/**"
               prefix="jsf-ri-src-${version}"/>
    </zip>
    <antcall target="ri.source"/>
    
  </target>

  <target name="tlddocs">

    <echo message="tlddoc.jar = ${tlddoc.jar}"/>

    <java fork="true" jar="${tlddoc.jar}">
      <arg line="-d ${build.home}/tlddocs"/>
      <arg line="-windowtitle jsf-ri-${version}"/>
      <arg value="${build.generate.tld}/html_basic.tld"/>
      <arg value="${conf.share.dir}/jsf_core.tld"/>
    </java>
  </target>

    <target name="compile.test" depends="prepare,compile"
     description="Run unit tests">

        <ant antfile="build-tests.xml" target="compile.test"/>
    
    </target>

    <target name="test" depends="run.junit.test,run.cactus.test,run.systest"
     description="Run all unit and system tests">
    </target>

    <target name="run.systest" description="Run system tests">
      <ant dir="${basedir}/systest" inheritall="false" target="safe.remove"/>
      <ant dir="${basedir}/systest" inheritall="false" target="install"/>
      <ant dir="${basedir}/systest" inheritall="false" target="test"/>
      <ant dir="${basedir}/systest" inheritall="false" target="remove"/>
    </target>

    <target name="run.junit.test" depends="compile.test"
     description="Run unit tests not requiring cactus">
        <ant antfile="build-tests.xml" target="run.test"/>
    </target>

    <target name="run.cactus.test" depends="compile.test,jars"
     description="Run unit tests requiring cactus">
        <ant antfile="build-tests.xml" target="execute.cactus.tests"/>
    </target>

    <target name="force.run.cactus.test" depends="compile.test,jars"
     description="Run unit tests requiring cactus, forcing reinstall">
        <ant antfile="build-tests.xml" target="force.execute.cactus.tests"/>
    </target>

    <target name="passthru">
        <echo>Invoking target ${passthru}</echo>
        <ant antfile="build-tests.xml" target="${passthru}"/>
    </target>

  <!-- 
       =================================================================== 
         Create the jars
       =================================================================== 
  -->
  <target name="jars" depends="compile">
    <jar jarfile="${build.home}/lib/${name}.jar" 
         basedir="${build.home}/classes" > 
         <manifest>
          <attribute name="Specification-Title" value="JavaServer Faces"/>
          <attribute name="Specification-Version" value="1.0"/>
          <attribute name="Implementation-Title" value="'${name}': ${Name}"/>
          <attribute name="Implementation-Version" value="${version}"/>
          <attribute name="Implementation-Vendor" value="Sun Microsystems, Inc."/>
          <attribute name="Implementation-Vendor-Id" value="com.sun"/>
          <attribute name="Extension-Name" value="com.sun.faces"/>
        </manifest>
    </jar>

  </target>

  <!--
       ==================================================================
          TCK related
       ==================================================================
  -->
                                                                                
  <target name="detect.tck" description="Detect the presence of the JSF TCK">
      <available property="jsf.tck.present" file="${jsf-tck.home}" type="dir"/>
  </target>
                                                                                
  <target name="copy.to.tck" description="Copy the jsf-impl.jar to TCK_HOME/weblib"
          if="jsf.tck.present">
      <copy file="${build.home}/lib/${name}.jar" todir="${jsf-tck.home}/weblib"
            overwrite="true"/>
  </target>


<!--
       ===================================================================
         Tomcat integration targets
       ===================================================================
  -->

  <target name="list"
   description="List installed webapps on Tomcat">
    <list url="${url}" username="${username}" password="${password}"/>
  </target>

     <!--
      ===================================================================
       This target copies the JSF libraries under ${jwsdp.home}. This
       target simulates JWSDP 1.2 distribution environment.
      ===================================================================
     -->
   <target name="jsf.deploy.wspack" depends="jars">
     <mkdir dir="${tomcat.home}/jsf"/>
     <mkdir dir="${tomcat.home}/jsf/lib"/>

     <copy file="${build.home}/lib/${name}.jar" todir="${tomcat.home}/jsf/lib"/>
     <copy file="${jsf-api.jar}" todir="${tomcat.home}/jsf/lib"/>
   </target>


  <target name="main" depends="jars,copy.to.tck"/>

</project>
