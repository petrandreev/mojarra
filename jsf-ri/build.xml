<?xml version="1.0"?>

<!-- ************ JSF build file ************************************** -->

<project name="JSF-RI" default="main" basedir=".">

  <property name="Name" value="JSF RI"/>
  <property name="name" value="jsf-ri"/>
  <property name="version" value="pre-EA1"/>

<!-- ************ Per user local properties ******************************* -->

  <property file="${user.home}/build.properties"/>   <!-- User local        -->
  <property file="build.properties"/>                <!-- Component local   -->
  <property file="../build.properties"/>             <!-- Commons local     -->


<!-- ************ Where are we building into? ***************************** -->

  <!-- The base directory for compilation targets -->
  <property name="build.home" value="${basedir}/build"/>

  <!-- The base directory for the JSF APIs -->
  <property name="jsf.api.home" value ="../jsf-api"/>

  <!-- The base directory for distribution targets -->
  <property name="dist.home" value="${basedir}/dist"/>

  <!-- The base directory for component sources -->
  <property name="source.home" value="${basedir}/src"/>

  <!-- The base directory for dependent jars -->
  <property name="lib.home" value="${basedir}/lib"/>

  <!-- The base directory for executable scripts -->
  <property name="bin.home" value="${basedir}/etc/bin"/>

  <!-- The base directory for unit test sources -->
  <property name="test.home" value="${basedir}/test/src"/>

  <!-- The base directory for benchmark sources -->
  <property name="benchmark.home" value="${basedir}/test-benchmark/src"/>

  <!-- The home directory for Ant -->
  <property name="ant.home" value="${basedir}/lib"/>

  <!-- Application name to deploy under tomcat -->
  <property name="app.name"       value="fruitstand"/>

  <!-- ************ Dependencies **** *************************************** -->

  <!-- The locations of necessary jar files -->
  <property name="mozutil.jar" value="${lib.home}/mozutil.jar"/>
  <property name="servlet.jar" value="${lib.home}/servlet.jar"/>
  <property name="jsf-api.jar" value="${jsf.api.home}/build/lib/jsf-api.jar"/>

<!-- ************ Compiler Defaults *************************************** -->

  <!-- Should Java compilations set the 'debug' compiler option? -->
  <property name="compile.debug" value="true"/>

  <!-- Should Java compilations set the 'deprecation' compiler option? -->
  <property name="compile.deprecation" value="false"/>

  <!-- Should Java compilations set the 'optimize' compiler option? -->
  <property name="compile.optimize" value="false"/>

  <!-- Construct compile classpath -->
  <path id="compile.classpath">
    <pathelement location="${build.home}/classes"/>
    <pathelement location="${jsf-api.jar}"/>
    <pathelement location="${servlet.jar}"/>
  </path>

  <path id="test.classpath">
    <pathelement location="${build.home}/classes" />
    <pathelement location="${build.home}/test/classes" />
    <pathelement path="${java.class.path}"/>
    <path refid="compile.classpath" />
  </path>

  <path id="benchmark.classpath">
    <pathelement location="${build.home}/classes" />
    <pathelement location="${build.home}/test-benchmark/classes" />
    <pathelement path="${java.class.path}"/>
    <path refid="compile.classpath" />
  </path>

    <!-- Directory where core struts library configurations files are stored -->
    <property name="conf.share.dir" value="conf/share"/>


<!-- ************ Executable Targets ************************************** -->


  <target name="init"
   description="Initialize and evaluate conditionals">
    <echo message="-------- ${Name} ${version} --------"/>
  </target>

  <target name="prepare" depends="init"
   description="Prepare build directory">
    <mkdir dir="${build.home}"/>
    <mkdir dir="${build.home}/bin"/>
    <mkdir dir="${build.home}/classes"/>
    <mkdir dir="${build.home}/javadocs"/>
    <mkdir dir="${build.home}/lib"/>
    <mkdir dir="${build.home}/test"/>
    <mkdir dir="${build.home}/test/classes"/>
    <mkdir dir="${build.home}/test-benchmark"/>
    <mkdir dir="${build.home}/test-benchmark/classes"/>
    <mkdir dir="${build.home}/library/classes/META-INF/tlds"/>
    <copy file="${conf.share.dir}/html_basic.tld"
         tofile="${build.home}/library/classes/META-INF/html_basic.tld"/>
    <!-- unjar mozutil to classes, so we don't have to expose it -->
    <exec dir="${build.home}/classes" executable="jar">
      <arg line="-xf ${mozutil.jar}"/>
    </exec>
  </target>

  <target name="compile" depends="prepare"
   description="Just compile the classes">
    <!-- Run javac through everything -->
    <javac  srcdir="${source.home}"
           destdir="${build.home}/classes"
             debug="${compile.debug}"
       deprecation="${compile.deprecation}"
          optimize="${compile.optimize}">
      <classpath refid="compile.classpath"/>
    </javac>
    <copy todir="${build.home}/classes">
        <fileset dir="${source.home}" includes="**/*.properties"/>
    </copy>

    </target>

  <target name="clean"
   description="Clean build and distribution directories">
    <delete    dir="${build.home}"/>
    <delete    dir="${dist.home}"/>
    <delete> 
      <fileset dir="." includes="**/*~" defaultexcludes="no"/>
    </delete>
  </target>

  <target name="build.war" depends="clean,prepare,compile" >
     <!-- name of the war file -->
     <property name="dist.war"  value="${app.name}.war"/>
     <mkdir  dir="${dist.home}/${app.name}"/>

     <!-- copy app.name directory under dist.home -->
    <copy todir="${dist.home}/${app.name}">
      <fileset dir="${basedir}/web/${app.name}" />
    </copy>

    <!-- copy all the classes under com.sun.faces package -->
    <copy todir="${dist.home}/${app.name}/WEB-INF/classes">
      <fileset dir="${build.home}/classes" excludes="**/CVS/**" />
    </copy>
    
    <!-- copy all the classes under javax.faces package -->
    <copy file="${jsf-api.jar}" todir="${dist.home}/${app.name}/WEB-INF/classes"/>

    <!-- copy tld file -->
    <copy file="${conf.share.dir}/html_basic.tld"
         toDir="${dist.home}/${app.name}/WEB-INF"/>

    <!-- create a war file for distribution -->
    <jar jarfile="${dist.home}/${dist.war}"
         basedir="${dist.home}/${app.name}"/>
  </target>

  <!-- deploy the web-app under tomcat. tomcat_home needs to be set prior
       to running this target -->

  <target name="deploy.tomcat" depends="prepare,compile">

    <!-- Directory name to deploy under tomcat -->
    <property name="deploy.home"  value="${tomcat.home}/webapps/${app.name}"/>

    <!-- copy app.name directory to tomcat/webapps -->
    <copy todir="${deploy.home}">
      <fileset dir="${basedir}/web/${app.name}" />
    </copy>

    <mkdir dir="${deploy.home}/WEB-INF/classes" />
    <!-- copy all classes from com.sun.faces package -->
    <copy todir="${deploy.home}/WEB-INF/classes">
      <fileset dir="${build.home}/classes" excludes="**/CVS/**" />
    </copy>
    <copy file="${conf.share.dir}/html_basic.tld"
         toDir="${deploy.home}/WEB-INF"/>

    
    <!-- copy all classes from javax.api package -->
    <copy  file="${jsf-api.jar}" todir="${deploy.home}/WEB-INF/lib"/>

    <!-- copy dependent libs to tomcat/libs -->
  </target>

  <target name="all" depends="clean,prepare,compile,build.war,deploy.tomcat"
   description="Clean and compile all components"/>

  <target name="dist">
    <mkdir dir="${dist.home}"/>
    <mkdir dir="${dist.home}/bin"/>
    <mkdir dir="${dist.home}/lib"/>

    <copy    todir="${dist.home}/bin">
      <fileset dir="${build.home}/bin"/>
    </copy>

    <chmod perm="+x" file="${dist.home}/bin/wsdlp.sh"/>
    <chmod perm="+x" file="${dist.home}/bin/xrpcc.sh"/>

    <copy    todir="${dist.home}/lib">
      <fileset dir="${build.home}/lib"/>
    </copy>
  </target>

  <target name="javadocs" 
          description="Create the API documentation">
    <javadoc packagenames="com.sun.*"
             sourcepath="${source.home}"
             destdir="${build.home}/javadocs"
             author="false"
             version="false"
             windowtitle="${Name} Generated Documentation"
             doctitle="${Name}"
             bottom="Copyright &#169; 2001 Sun Microsystems, Inc. All Rights Reserved.">
        <classpath refid="compile.classpath"/>
    </javadoc>
  </target>

  <target name="compile-tests"
          description="Compile the unit tests">
    <javac srcdir="${test.home}"
           destdir="${build.home}/test/classes"
           debug="${compile.debug}"
           deprecation="${compile.deprecation}" >
      <include name="**/*.java" />
      <classpath refid="test.classpath" />
    </javac>
  </target>

  <target name="run-tests" depends="compile-tests"
          description="Run the unit tests">
    <junit printsummary="no" haltonfailure="no" fork="true">
      <classpath refid="test.classpath"/>
      <formatter type="plain" usefile="false" />
      <batchtest>
        <fileset dir="${build.home}/test/classes">
          <include name="**/AllTests.class" />
        </fileset>
      </batchtest>
    </junit>
  </target>

  <target name="run-factory" depends="compile" 
   description="Run the factory test">
    <java classname="com.sun.faces.renderkit.html_basic.HtmlBasicRenderContextFactory">
      <classpath refid="compile.classpath"/>
    </java>
  </target>

  <target name="test-objectmanager" depends="compile" 
   description="Run the test of ObjectManager">
    <java classname="com.sun.faces.ObjectTableImpl">
      <classpath refid="compile.classpath"/>
    </java>
  </target>

  <target name="run-single-test" if="testcase" depends="compile-tests"
          description="Run a unit test">
    <junit printsummary="no" haltonfailure="yes" fork="true">
      <classpath refid="test.classpath"/>
      <formatter type="plain" usefile="false" />
      <test name="${testcase}" />
    </junit>
  </target>

  <target name="compile-benchmarks"
          description="Compile the benchmarks">
    <javac srcdir="${benchmark.home}"
           destdir="${build.home}/test-benchmark/classes"
           debug="false"
           optimize="true"
           deprecation="false" >
      <include name="**/*.java" />
      <classpath refid="benchmark.classpath" />
    </javac>
  </target>

  <target name="run-benchmarks" depends="compile-benchmarks"
          description="Run the benchmarks">
    <java classname="xml_benchmark.Main"
          classpathref="benchmark.classpath"
          fork="true" />
    <java classname="stub_tie_benchmark.Main"
          classpathref="benchmark.classpath"
          fork="true" />
  </target>

  <target name="main" depends="prepare,compile"/>

</project>
