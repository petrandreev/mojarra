<?xml version="1.0"?>

<!--
 Copyright 2003 Sun Microsystems, Inc. All rights reserved.
 SUN PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
-->


<!-- ************ JSF build file ************************************** -->

<project name="JSF-RI" default="main" basedir=".">

  <property name="Name" value="JavaServer Faces RI"/>
  <property name="name" value="jsf-ri"/>
  <property name="version" value="20030408"/>

<!-- ************ Per user local properties ******************************* -->

  <property file="${user.home}/build.properties"/>   <!-- User local        -->
  <property file="build.properties"/>                <!-- Component local   -->
  <property file="../build.properties"/>             <!-- Commons local     -->
  <property environment="myenv" />


<!-- ************ Where are we building into? ***************************** -->

  <!-- the root of our tomcat -->

  <!-- The base directory for compilation targets -->
  <property name="build.home" value="${basedir}/build"/>

  <!-- The base directory for the JSF APIs -->
  <property name="jsf.api.home" value ="../jsf-api"/>

  <!-- The base directory for the JSF DEMOs -->
  <property name="jsf.demo.home" value ="../jsf-demo"/>

  <!-- The base directory for distribution targets -->
  <property name="dist.home" value="${basedir}/dist"/>

  <!-- The base directory for component sources -->
  <property name="source.home" value="${basedir}/src"/>

  <!-- The base directory for component tests -->
  <property name="test.home" value="${basedir}/test"/>

  <!-- The base directory for dependent jars -->
  <property name="lib.home" value="${basedir}/lib"/>

  <!-- The base directory for executable scripts -->
  <property name="bin.home" value="${basedir}/etc/bin"/>

  <!-- The home directory for Ant -->
  <property name="ant.home" value="${basedir}/lib"/>

  <!-- Name of ultra-simple web-app -->
  <property name="basic.name"  value="basic"/>


  <!-- ************ Dependencies **** *************************************** -->

  <!-- The locations of necessary jar files -->
  <property name="mozutil.jar" value="${lib.home}/mozutil.jar"/>
  <property name="servlet.jar" value="${tomcat.home}/common/lib/servlet.jar"/>
  <property name="catalina-ant.jar" value="${tomcat.home}/server/lib/catalina-ant.jar"/>
  <property name="xerces.jar" value="${tomcat.home}/jaxp-1.2.2/lib/endorsed/xercesImpl.jar"/>
  <property name="commons-beanutils.jar"
            value="${tomcat.home}/server/lib/commons-beanutils.jar"/>
  <property name="commons-collections.jar" 
            value="${tomcat.home}/common/lib/commons-collections.jar"/>
  <property name="commons-logging.jar" 
            value="${tomcat.home}/jwsdp-shared/lib/commons-logging.jar"/>
  <property name="commons-digester.jar" 
            value="{tomcat.home}/server/lib/commons-digester.jar"/>
  <property name="jsf.api.jar" value="${jsf.api.home}/build/lib/jsf-api.jar"/>
  <property name="jsf.api.dtd" value="${jsf.api.home}/build/lib/web-facesconfig_1_0.dtd"/>
  <property name="jsp.jar" value="" />

<!-- ************ Compiler Defaults *************************************** -->

  <!-- Should Java compilations set the 'debug' compiler option? -->
  <property name="compile.debug" value="true"/>

  <!-- Should Java compilations set the 'deprecation' compiler option? -->
  <property name="compile.deprecation" value="false"/>

  <!-- Should Java compilations set the 'optimize' compiler option? -->
  <property name="compile.optimize" value="false"/>

  <!-- Construct compile classpath -->
  <path id="compile.classpath">
    <pathelement location="${build.home}/classes"/>
    <pathelement location="${commons-beanutils.jar}"/>
    <pathelement location="${commons-collections.jar}"/>
    <pathelement location="${commons-digester.jar}"/>
    <pathelement location="${commons-logging.jar}"/>
    <pathelement location="${jsf.api.jar}"/>
    <pathelement location="${servlet.jar}"/>
    <pathelement location="${jsp.jar}"/> 
    <pathelement location="${xerces.jar}"/>
    <pathelement location="${jstl.jar}"/>
  </path>

  <path id="catalina-ant.classpath">
    <pathelement location="${catalina-ant.jar}"/>
  </path>

  <!-- Custom Tomcat Integration -->
  <taskdef  name="install"  classname="org.apache.catalina.ant.InstallTask">
      <classpath refid="catalina-ant.classpath" />
  </taskdef>
  <taskdef  name="list"     classname="org.apache.catalina.ant.ListTask">
      <classpath refid="catalina-ant.classpath" />
  </taskdef>    
  <taskdef  name="reload"   classname="org.apache.catalina.ant.ReloadTask">
      <classpath refid="catalina-ant.classpath" />
  </taskdef>
  <taskdef  name="remove"   classname="org.apache.catalina.ant.RemoveTask">
      <classpath refid="catalina-ant.classpath" />
  </taskdef>
  <property name="context.path" value="/basic"/>
  <property name="url"      value="http://localhost:8080/manager"/>


    <!-- Directory where core struts library configurations files are stored -->
    <property name="conf.share.dir" value="conf/share"/>


<!-- ************ Executable Targets ************************************** -->

  <!-- 
       ===================================================================
         Convenience target: cvs update              
       =================================================================== 
  -->
  <target name="cvsupdate">
    <cvs command="update -d -P"/>
  </target>

  <!-- 
       ===================================================================
         Convenience target: pull.clean.build
       =================================================================== 
  -->
  <target name="pull.clean.build" depends="cvsupdate,clean,main">
  </target>


  <target name="init"
   description="Initialize and evaluate conditionals">
    <echo message="-------- ${Name} ${version} --------"/>
  </target>

  <target name="prepare" depends="init"
   description="Prepare build directory">
    <mkdir dir="${build.home}"/>
    <mkdir dir="${build.home}/bin"/>
    <mkdir dir="${build.home}/classes"/>
    <mkdir dir="${build.home}/classes/META-INF"/>
    <mkdir dir="${build.home}/javadocs"/>
    <mkdir dir="${build.home}/lib"/>
    <copy file="${conf.share.dir}/html_basic.tld"
         toDir="${build.home}/classes/META-INF"/>
    <copy file="${conf.share.dir}/jsf_core.tld"
         toDir="${build.home}/classes/META-INF"/>
    <!-- unjar mozutil to classes, so we don't have to expose it -->
    <unjar src="${mozutil.jar}" dest="${build.home}/classes"/>
  </target>

  <target name="compile" depends="prepare"
   description="Just compile the classes">
    <!-- Run javac through everything -->
    <javac  srcdir="${source.home}"
           destdir="${build.home}/classes"
             debug="${compile.debug}"
       deprecation="${compile.deprecation}"
          optimize="${compile.optimize}">
      <classpath refid="compile.classpath"/>
    </javac>
    <copy todir="${build.home}/classes">
        <fileset dir="${source.home}" includes="**/*.properties"/>
    </copy>
    <copy todir="${build.home}/classes">
        <fileset dir="${source.home}" includes="**/*.xml"/>
    </copy>
    <copy  file="${jsf.api.dtd}"
          todir="${build.home}/classes/com/sun/faces/config"/>

    </target>

  <target name="clean" 
   description="Clean build and distribution directories">
    <delete    dir="${build.home}"/>
    <delete    dir="${dist.home}"/>
    <delete> 
      <fileset dir="." includes="**/*~" defaultexcludes="no"/>
      <fileset dir="." includes="**/.nbattrs" defaultexcludes="no"/>
    </delete>
    <delete file="jsf-${version}.zip"/>
    <delete file="jsf-${version}_src.zip"/>
    <delete  dir="${tomcat.home}/jsf-${version}/lib" />
  </target>

  <target name="create.source.bundle" depends="clean">

    <mkdir dir="${dist.home}"/>
    <copy todir="${dist.home}/jsf-api">
        <fileset dir="${jsf.api.home}"/>
    </copy>
    <copy todir="${dist.home}/jsf-ri">
        <fileset dir="${basedir}"/>
    </copy>

    <!-- create the zip file -->
    <zip zipfile="jsf-${version}_src.zip" basedir="${dist.home}" />

  </target>

  <target name="all" depends="clean,prepare,compile,build.basic.war"
   description="Clean and compile all components"/>

  <target name="prepare.dist" depends="jars">
    <mkdir dir="${dist.home}"/>
    <mkdir dir="${dist.home}/example"/>

    <echo> Handle the top level files </echo>
    <copy file="README" todir="${dist.home}"/>
    <copy file="ReleaseNotes.html" todir="${dist.home}"/>
    <copy file="LICENSE.html" todir="${dist.home}"/>
    <copy file="LICENSE-APACHE.txt" todir="${dist.home}"/>
    <copy file="LICENSE-MOZILLA.txt" todir="${dist.home}"/>
    <copy file="${jsf.api.dtd}" todir="${dist.home}"/>

    <echo> Build the API Javadocs </echo>
    <ant dir="${jsf.api.home}" 
         antfile="${jsf.api.home}/build.xml" target="javadocs"/>
    <echo> Copy the API Javadocs to the dist </echo>
    <copy todir="${dist.home}/javadocs">
      <fileset dir="${jsf.api.home}/build/javadocs"/>
    </copy>
   </target>

   
    <target name="copyJars" depends="prepare.dist" if="build.standalone">
    <echo> copy the necessary libs </echo>
    <copy file="${commons-beanutils.jar}" todir="${dist.home}/lib"/>
    <copy file="${commons-collections.jar}" todir="${dist.home}/lib"/>
    <copy file="${commons-digester.jar}" todir="${dist.home}/lib"/>
    <copy file="${commons-logging.jar}" todir="${dist.home}/lib"/>
    <copy file="${jstl.jar}" todir="${dist.home}/lib"/>
    <copy file="${standard.jar}" todir="${dist.home}/lib"/>
    <copy file="${jsf.api.jar}" todir="${dist.home}/lib"/>
    <copy file="${build.home}/lib/${name}.jar" todir="${dist.home}/lib"/>
    <copy file="${conf.share.dir}/html_basic.tld" todir="${dist.home}/lib"/>
    <copy file="${conf.share.dir}/jsf_core.tld" todir="${dist.home}/lib"/>
  </target>

  <target name="wspack.copyJars" depends="prepare.dist" if="build.wspack">
    <echo> copy the necessary libs </echo>
    <copy file="${jsf.api.jar}" todir="${dist.home}/lib"/>
    <copy file="${build.home}/lib/${name}.jar" todir="${dist.home}/lib"/>
    <copy file="${conf.share.dir}/html_basic.tld" todir="${dist.home}/lib"/>
    <copy file="${conf.share.dir}/jsf_core.tld" todir="${dist.home}/lib"/>
  </target>

  <target name="dist.binary" depends="dist.source, wspack.dist.source" >
    <echo> Build the demos from the jsf-demo repository </echo>
    <ant dir="${jsf.demo.home}" target="build-all"
         antfile="${jsf.demo.home}/build.xml" />
    <echo> copy the example war files to the zip area </echo>
    <copy todir="${dist.home}/example" 
          file="${jsf.demo.home}/components/build/components.war"/>
    <copy todir="${dist.home}/example"
          file="${jsf.demo.home}/cardemo/build/cardemo.war"/>
    <copy todir="${dist.home}/example" 
          file="${jsf.demo.home}/guessNumber/build/guessNumber.war"/>
    <copy todir="${dist.home}/example" 
          file="${jsf.demo.home}/nonjsp/dist/nonjsp.war"/> 
    <echo> copy the demo-components.jar </echo>
    <copy todir="${dist.home}/example" 
     file="${jsf.demo.home}/components/build/demo/WEB-INF/lib/demo-components.jar"/>
  </target>

  <target name="dist.source" depends="copyJars" if="build.standalone">
    <echo> prepare to copy the demo source </echo>
    <ant dir="${jsf.demo.home}" 
         antfile="${jsf.demo.home}/build.xml" target="clean"/>
    <ant dir="${jsf.demo.home}"
         antfile="${jsf.demo.home}/build.xml" target="copyJars"/>
    <ant target="copyDemoSource" />
  </target>

  <target name="wspack.dist.source" depends="wspack.copyJars" if="build.wspack">

    <echo> prepare to copy the demo source </echo>
    <ant dir="${jsf.demo.home}" 
         antfile="${jsf.demo.home}/build.xml" target="clean"/>
    <ant target="copyDemoSource" />
  </target>

  <target name="copyDemoSource">
    <echo> copy the necessary examples </echo>

    <copy todir="${dist.home}/example/guessNumber" includeEmptyDirs="false">
      <fileset dir="${jsf.demo.home}/guessNumber"/>
    </copy>

    <copy todir="${dist.home}/example/cardemo" includeEmptyDirs="false">
      <fileset dir="${jsf.demo.home}/cardemo"/>
    </copy>

    <copy todir="${dist.home}/example/nonjsp" includeEmptyDirs="false">
      <fileset dir="${jsf.demo.home}/nonjsp"/>
    </copy>

    <copy todir="${dist.home}/example/components" includeEmptyDirs="false">
      <fileset dir="${jsf.demo.home}/components"/>
    </copy>

  </target>

  <!-- Create the source distribution -->
  <target name="ri.source">
    <zip     destfile="${dist.home}/jsf-ri-src-${version}.zip">
      <zipfileset dir="${basedir}"
             includes="build.xml build-tests.xml README COPYRIGHT LICENSE*.*"
               prefix="jsf-ri-src-${version}"/>
      <zipfileset dir="${source.home}"
             excludes="**/CVS/**"
               prefix="jsf-ri-src-${version}/src"/>
      <zipfileset dir="${test.home}"
             excludes="**/CVS/**"
               prefix="jsf-ri-src-${version}/test"/>
      <zipfileset dir="${basedir}"
             includes="conf/** web/**"
               prefix="jsf-ri-src-${version}"/>
    </zip>
  </target>


  <target name="dist" depends="dist.binary">
    <echo> create the zip file </echo>
    <move todir="${basedir}/jsf-${version}">
      <fileset dir="dist"/>
    </move>
    <zip zipfile="jsf-${version}.zip">
      <fileset dir="${basedir}"
               includes="jsf-${version}/**"/>
    </zip>
    <move todir="dist">
      <fileset dir="${basedir}/jsf-${version}"/>
    </move>

  </target>

  <target name="wspack" depends="dist.binary" >
    <copy todir="${wspack.home}">
      <fileset dir="${dist.home}"/>
    </copy>
  </target>

  <target name="javadocs" 
          description="Create the API documentation">
    <javadoc packagenames="com.sun.*"
             sourcepath="${source.home}"
             destdir="${build.home}/javadocs"
             author="false"
             version="false"
             windowtitle="${Name} Generated Documentation"
             doctitle="${Name}"
             bottom="Copyright &#169; 2001 Sun Microsystems, Inc. All Rights Reserved.">
        <classpath refid="compile.classpath"/>
    </javadoc>
  </target>

    <target name="compile.test" depends="prepare,compile"
     description="Run unit tests">

        <ant antfile="build-tests.xml" target="compile.test"/>
    
    </target>

    <target name="run.test" depends="run.junit.test,run.cactus.test"
     description="Run all unit tests">
    </target>

    <target name="run.junit.test" depends="compile.test"
     description="Run unit tests not requiring cactus">

        <ant antfile="build-tests.xml" target="run.test"/>
    
    </target>


    <target name="run.cactus.test" depends="compile.test,jars,run.cactus.test.40,run.cactus.test.50"
     description="Run unit tests requiring cactus"/>

    <target name="run.cactus.test.40" if="tomcat.home.40">
        <ant antfile="build-tests.xml" target="test.tomcat.40"/>
    </target>

    <target name="run.cactus.test.50" if="tomcat.home.50">
        <ant antfile="build-tests.xml" target="test.tomcat.50"/>
    </target>


    <!-- builds"basic" sample app -->
    <target name="build.basic.war" depends="prepare,compile,jars,compile.basic.sample" >
     <!-- name of the war file -->
     <property name="dist.war"  value="${basic.name}.war"/>

     <mkdir  dir="${dist.home}/${basic.name}"/>

     <!-- copy basic directory under dist.home -->
    <copy todir="${dist.home}/${basic.name}">
      <fileset dir="${basedir}/web/${basic.name}" />
    </copy>

    <!-- copy all the classes under basic package -->
    <copy todir="${dist.home}/${basic.name}">
      <fileset dir="${build.home}/${basic.name}"/>
    </copy>

    <!-- copy dependent libs -->
    <copy  file="${commons-beanutils.jar}" todir="${dist.home}/${basic.name}/WEB-INF/lib"/>
    <copy  file="${commons-collections.jar}" todir="${dist.home}/${basic.name}/WEB-INF/lib"/>
    <copy  file="${commons-digester.jar}" todir="${dist.home}/${basic.name}/WEB-INF/lib"/>
    <copy  file="${commons-logging.jar}" todir="${dist.home}/${basic.name}/WEB-INF/lib"/>
    <copy  file="${standard.jar}" todir="${dist.home}/${basic.name}/WEB-INF/lib"/>
    <copy  file="${jstl.jar}" todir="${dist.home}/${basic.name}/WEB-INF/lib"/>

    <copy file="${jsf.api.jar}" todir="${dist.home}/${basic.name}/WEB-INF/lib"/>
    <copy file="${build.home}/lib/${name}.jar"  todir="${dist.home}/${basic.name}/WEB-INF/lib"/>

    <!-- create a war file for distribution -->
    <jar jarfile="${dist.home}/${dist.war}"
         basedir="${dist.home}/${basic.name}"/> 

  </target>

  <target name="compile.basic.sample"
          description="Compile java files in the sample app named basic.name">
    <property name="basic.name"  value="basic"/>
    <mkdir dir="${build.home}/${basic.name}/WEB-INF/classes"/>
    <javac  srcdir="${basedir}/web/${basic.name}/WEB-INF/src"
           destdir="${build.home}/${basic.name}/WEB-INF/classes"
             debug="${compile.debug}"
       deprecation="${compile.deprecation}"
          optimize="${compile.optimize}">
      <classpath refid="compile.classpath"/>
    </javac>
    <copy todir="${build.home}/${basic.name}/WEB-INF/classes">
        <fileset dir="${basedir}/web/${basic.name}/WEB-INF/src"
                 includes="**/*.properties"/>
    </copy>
  </target>

  <!-- 
       =================================================================== 
         Create the jars
       =================================================================== 
  -->
  <target name="jars" depends="compile">
    <jar jarfile="${build.home}/lib/${name}.jar" 
         basedir="${build.home}/classes" > 
         <manifest>
          <attribute name="Specification-Title" value="JavaServer Faces"/>
          <attribute name="Specification-Version" value="1.0"/>
          <attribute name="Implementation-Title" value="'${name}': ${Name}"/>
          <attribute name="Implementation-Version" value="${version}"/>
          <attribute name="Implementation-Vendor" value="Sun Microsystems, Inc."/>
          <attribute name="Implementation-Vendor-Id" value="com.sun"/>
          <attribute name="Extension-Name" value="com.sun.faces"/>
        </manifest>
    </jar>

  </target>

  <!--
       ===================================================================
        This target copies the JSF libraries under ${jwsdp.home}. This 
        target simulates JWSDP 1.2 distribution environment.
       ===================================================================
  -->
  <target name="wspack.jars" depends="jars">
    <mkdir dir="${tomcat.home}/jsf-${version}"/>
    <mkdir dir="${tomcat.home}/jsf-${version}/lib"/>

    <copy file="${build.home}/lib/${name}.jar" todir="${tomcat.home}/jsf-${version}/lib"/>
    <copy file="${jsf.api.jar}" todir="${tomcat.home}/jsf-${version}/lib"/>

  </target>


<!--
       ===================================================================
         Tomcat integration targets
       ===================================================================
  -->

  <target name="install" depends="build.basic.war"
   description="Install webapp on Tomcat">
    <install url="${url}" username="${username}" password="${password}"
            path="${context.path}"
             war="file://${dist.home}/${basic.name}"/>
  </target>

  <target name="list"
   description="List installed webapps on Tomcat">
    <list url="${url}" username="${username}" password="${password}"/>
  </target>

  <target name="reload" depends="build.basic.war"
   description="Reload this webapp on Tomcat">
    <reload url="${url}" username="${username}" password="${password}"
            path="${context.path}"/>
  </target>

  <target name="remove"
   description="Remove this webapp from Tomcat">
    <remove url="${url}" username="${username}" password="${password}"
            path="${context.path}"/>
  </target>

  <target name="deploy.tomcat" depends="build.basic.war"
   description="Deploy the basic.war to tomcat">
     <copy file="${dist.home}/${dist.war}"
       toDir="${tomcat.home}/webapps"/>

  </target>

  <target name="main" depends="prepare,compile,jars"/>

</project>
